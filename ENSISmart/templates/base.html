
<html>
    <head>
        <title>Calendar</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/locale/fr.js"></script>
    </head>

    <body>

    <div class="container">
        <div class="row">
           <h4>Calendrier des cours</h4> 
           {% block content %} {% endblock %}

        <div class="col-md-12 mt-3">
            <h5>Upload le fichier ICS</h5>
                <form method="post" enctype="multipart/form-data" action="/ENSISmart/upload_ics/">
                    {% csrf_token %}
                    <input type="file" name="ics_file" class="form-control mb-2" required>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
        </div>



    <div class="container">
        <div class="row">
            <form method="post" id="upload-ical-form" action="{% url 'upload_icalendar_link' %}" class="form-inline">
                {% csrf_token %}
                <h5>ICalendar URL</h5>
                <input type="url" name="ical_url" id="ical_url" class="form-control mb-2" required>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
        </div>
        <div class="row">
            <h4>Calendar Events</h4> 
            <a href="{% url 'display_events' %}" class="btn btn-primary">Show Event List</a>
        </div>
        <div class="row mt-3">
            <button id="delete-all-events" class="btn btn-danger">Delete All Events</button>
        </div>
    </div>
   
        </div>
    </div>
       
<script>
$(document).ready(function () {
    var calendar = $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        events: '/ENSISmart/all_events/',
        selectable: true,
        selectHelper: true,
        editable: true,
        eventLimit: true,
        select: function (start, end, allDay) {
            var title = prompt("Enter Event Title:");
            if (title) {
                var startDate = moment(start).format("YYYY-MM-DD");
                var startTime = prompt("Enter Start Time (HH:mm):", moment(start).format("HH:mm"));
                var endTime = prompt("Enter End Time (HH:mm):", moment(end).format("HH:mm"));

                if (startTime && endTime) {
                    var startDateTime = moment(startDate + " " + startTime, "YYYY-MM-DD HH:mm");
                    var endDateTime = moment(startDate + " " + endTime, "YYYY-MM-DD HH:mm");

                    if (startDateTime.isValid() && endDateTime.isValid()) {
                        $.ajax({
                            type: "GET",
                            url: '/ENSISmart/add_event/',
                            data: {
                                'title': title,
                                'start': startDateTime.format(),
                                'end': endDateTime.format()
                            },
                            dataType: "json",
                            success: function (data) {
                                calendar.fullCalendar('refetchEvents');
                                alert("Event added successfully");
                            },
                            error: function (data) {
                                alert('There was a problem adding the event.');
                            }
                        });
                    } else {
                        alert('Invalid time input.');
                    }
                } else {
                    alert('Start time and end time are required.');
                }
            }
        },
        eventResize: function (event) {
            var start = $.fullCalendar.formatDate(event.start, "Y-MM-DD HH:mm:ss");
            var end = $.fullCalendar.formatDate(event.end, "Y-MM-DD HH:mm:ss");
            var title = event.title;
            var id = event.id;
            $.ajax({
                type: "GET",
                url: '/ENSISmart/update/',
                data: {
                    'title': title,
                    'start': start,
                    'end': end,
                    'id': id
                },
                dataType: "json",
                success: function (data) {
                    calendar.fullCalendar('refetchEvents');
                    alert('Event updated');
                },
                error: function (data) {
                    alert('There was a problem updating the event.');
                }
            });
        },
        eventDrop: function (event) {
            var start = $.fullCalendar.formatDate(event.start, "Y-MM-DD HH:mm:ss");
            var end = $.fullCalendar.formatDate(event.end, "Y-MM-DD HH:mm:ss");
            var title = event.title;
            var id = event.id;
            $.ajax({
                type: "GET",
                url: '/ENSISmart/update/',
                data: {
                    'title': title,
                    'start': start,
                    'end': end,
                    'id': id
                },
                dataType: "json",
                success: function (data) {
                    calendar.fullCalendar('refetchEvents');
                    alert('Event updated');
                },
                error: function (data) {
                    alert('There was a problem updating the event.');
                }
            });
        },
        eventClick: function (event) {
            if (confirm("Are you sure you want to remove it?")) {
                var id = event.id;
                $.ajax({
                    type: "GET",
                    url: '/ENSISmart/remove/',
                    data: {'id': id},
                    dataType: "json",
                    success: function (data) {
                        calendar.fullCalendar('refetchEvents');
                        alert('Event removed');
                    },
                    error: function (data) {
                        alert('There was a problem removing the event.');
                    }
                });
            }
        }
    });

    $('#delete-all-events').click(function () {
        if (confirm("Are you sure you want to delete all events?")) {
            $.ajax({
                type: "GET",
                url: '/ENSISmart/delete_all_events/',
                dataType: "json",
                success: function (data) {
                    calendar.fullCalendar('refetchEvents');
                    alert('All events deleted');
                },
                error: function (data) {
                    alert('There was a problem deleting all events.');
                }
            });
        }
    });

    $('#upload-ical-form').submit(function (e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: "POST",
            url: form.attr('action'),
            data: form.serialize(),
            success: function (data) {
                calendar.fullCalendar('refetchEvents');
                alert('iCalendar events uploaded');
                $('#ical_url').val('');
            },
            error: function (data) {
                alert('There was a problem uploading the iCalendar events.');
            }
        });
    });
});

</script>
    
    
 </body>
</html>